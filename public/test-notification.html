<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é€šçŸ¥åŠŸèƒ½æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    button {
      background: #007AFF;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin-bottom: 10px;
    }
    button:active {
      opacity: 0.8;
    }
    .status {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    .success {
      background: #d4edda;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
    }
    .log {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ”” é€šçŸ¥åŠŸèƒ½æµ‹è¯•</h1>
    <p>è¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æµ‹è¯•é¡µé¢ï¼Œç”¨äºè¯Šæ–­é€šçŸ¥åŠŸèƒ½é—®é¢˜</p>
  </div>

  <div class="card">
    <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
    <div id="status"></div>
  </div>

  <div class="card">
    <h2>ğŸ§ª æµ‹è¯•æ“ä½œ</h2>
    <button onclick="checkPermission()">1. æ£€æŸ¥é€šçŸ¥æƒé™</button>
    <button onclick="requestPermission()">2. è¯·æ±‚é€šçŸ¥æƒé™</button>
    <button onclick="sendTestNotification()">3. å‘é€æµ‹è¯•é€šçŸ¥</button>
    <button onclick="sendMultipleNotifications()">4. å‘é€ 3 æ¡é€šçŸ¥</button>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
  </div>

  <div class="card">
    <h2>ğŸ“ æ—¥å¿—è¾“å‡º</h2>
    <div id="log" class="log"></div>
  </div>

  <script>
    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
      logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function clearLog() {
      document.getElementById('log').textContent = '';
      log('æ—¥å¿—å·²æ¸…ç©º');
    }

    // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
    function updateStatus() {
      const statusDiv = document.getElementById('status');
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                    window.navigator.standalone === true;
      const hasNotificationAPI = 'Notification' in window;
      const permission = hasNotificationAPI ? Notification.permission : 'N/A';

      let html = '';
      
      html += `<div class="status ${isIOS ? 'info' : 'success'}">
        <strong>å¹³å°:</strong> ${isIOS ? 'iOS' : 'å…¶ä»–'} ${isSafari ? 'Safari' : ''}
      </div>`;
      
      html += `<div class="status ${isPWA ? 'success' : 'error'}">
        <strong>PWA æ¨¡å¼:</strong> ${isPWA ? 'âœ… æ˜¯' : 'âŒ å¦'}
      </div>`;
      
      html += `<div class="status ${hasNotificationAPI ? 'success' : 'error'}">
        <strong>Notification API:</strong> ${hasNotificationAPI ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}
      </div>`;
      
      html += `<div class="status ${permission === 'granted' ? 'success' : permission === 'denied' ? 'error' : 'info'}">
        <strong>é€šçŸ¥æƒé™:</strong> ${permission}
      </div>`;

      statusDiv.innerHTML = html;

      log('ç³»ç»ŸçŠ¶æ€å·²æ›´æ–°');
      log(`å¹³å°: ${isIOS ? 'iOS' : 'å…¶ä»–'}, PWA: ${isPWA}, æƒé™: ${permission}`);
    }

    // æ£€æŸ¥æƒé™
    function checkPermission() {
      if (!('Notification' in window)) {
        log('æµè§ˆå™¨ä¸æ”¯æŒ Notification API', 'error');
        alert('æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½');
        return;
      }

      const permission = Notification.permission;
      log(`å½“å‰é€šçŸ¥æƒé™: ${permission}`);
      
      if (permission === 'granted') {
        log('âœ… å·²æˆæƒé€šçŸ¥æƒé™', 'success');
        alert('âœ… å·²æˆæƒé€šçŸ¥æƒé™');
      } else if (permission === 'denied') {
        log('âŒ é€šçŸ¥æƒé™è¢«æ‹’ç»', 'error');
        alert('âŒ é€šçŸ¥æƒé™è¢«æ‹’ç»\n\nè¯·åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å…è®¸é€šçŸ¥');
      } else {
        log('âš ï¸ å°šæœªè¯·æ±‚é€šçŸ¥æƒé™', 'info');
        alert('âš ï¸ å°šæœªè¯·æ±‚é€šçŸ¥æƒé™\n\nè¯·ç‚¹å‡»"è¯·æ±‚é€šçŸ¥æƒé™"æŒ‰é’®');
      }
      
      updateStatus();
    }

    // è¯·æ±‚æƒé™
    async function requestPermission() {
      if (!('Notification' in window)) {
        log('æµè§ˆå™¨ä¸æ”¯æŒ Notification API', 'error');
        alert('æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½');
        return;
      }

      log('æ­£åœ¨è¯·æ±‚é€šçŸ¥æƒé™...');
      
      try {
        const permission = await Notification.requestPermission();
        log(`æƒé™è¯·æ±‚ç»“æœ: ${permission}`);
        
        if (permission === 'granted') {
          log('âœ… ç”¨æˆ·å…è®¸äº†é€šçŸ¥æƒé™', 'success');
          alert('âœ… æƒé™å·²æˆäºˆï¼\n\nç°åœ¨å¯ä»¥å‘é€æµ‹è¯•é€šçŸ¥äº†');
        } else if (permission === 'denied') {
          log('âŒ ç”¨æˆ·æ‹’ç»äº†é€šçŸ¥æƒé™', 'error');
          alert('âŒ æƒé™è¢«æ‹’ç»\n\nå¦‚éœ€å¯ç”¨ï¼Œè¯·åœ¨ç³»ç»Ÿè®¾ç½®ä¸­ä¿®æ”¹');
        } else {
          log('âš ï¸ æƒé™è¯·æ±‚è¢«å¿½ç•¥', 'info');
        }
      } catch (error) {
        log(`æƒé™è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
        alert(`æƒé™è¯·æ±‚å¤±è´¥: ${error.message}`);
      }
      
      updateStatus();
    }

    // å‘é€æµ‹è¯•é€šçŸ¥
    function sendTestNotification() {
      if (!('Notification' in window)) {
        log('æµè§ˆå™¨ä¸æ”¯æŒ Notification API', 'error');
        alert('æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½');
        return;
      }

      if (Notification.permission !== 'granted') {
        log('æ²¡æœ‰é€šçŸ¥æƒé™ï¼Œè¯·å…ˆè¯·æ±‚æƒé™', 'error');
        alert('è¯·å…ˆç‚¹å‡»"è¯·æ±‚é€šçŸ¥æƒé™"æŒ‰é’®');
        return;
      }

      log('æ­£åœ¨å‘é€æµ‹è¯•é€šçŸ¥...');
      
      try {
        const notification = new Notification('æµ‹è¯•é€šçŸ¥', {
          body: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥æ¶ˆæ¯',
          icon: '/icon-192.png',
          badge: '/icon-192.png',
          tag: 'test',
        });

        notification.onshow = () => {
          log('âœ… é€šçŸ¥å·²æ˜¾ç¤º', 'success');
        };

        notification.onclick = () => {
          log('é€šçŸ¥è¢«ç‚¹å‡»');
          window.focus();
          notification.close();
        };

        notification.onerror = (error) => {
          log(`é€šçŸ¥æ˜¾ç¤ºé”™è¯¯: ${error}`, 'error');
        };

        log('é€šçŸ¥å¯¹è±¡å·²åˆ›å»º', 'success');
      } catch (error) {
        log(`å‘é€é€šçŸ¥å¤±è´¥: ${error.message}`, 'error');
        alert(`å‘é€å¤±è´¥: ${error.message}`);
      }
    }

    // å‘é€å¤šæ¡é€šçŸ¥
    function sendMultipleNotifications() {
      if (!('Notification' in window)) {
        log('æµè§ˆå™¨ä¸æ”¯æŒ Notification API', 'error');
        return;
      }

      if (Notification.permission !== 'granted') {
        log('æ²¡æœ‰é€šçŸ¥æƒé™', 'error');
        alert('è¯·å…ˆè¯·æ±‚é€šçŸ¥æƒé™');
        return;
      }

      log('å¼€å§‹å‘é€ 3 æ¡é€šçŸ¥...');
      
      const messages = [
        'ç¬¬ä¸€æ¡é€šçŸ¥',
        'ç¬¬äºŒæ¡é€šçŸ¥',
        'ç¬¬ä¸‰æ¡é€šçŸ¥'
      ];

      messages.forEach((msg, index) => {
        setTimeout(() => {
          try {
            const notification = new Notification(`æµ‹è¯• ${index + 1}`, {
              body: msg,
              icon: '/icon-192.png',
              tag: `test-${index}`,
            });
            log(`âœ… å·²å‘é€: ${msg}`, 'success');
          } catch (error) {
            log(`âŒ å‘é€å¤±è´¥: ${error.message}`, 'error');
          }
        }, index * 2000); // æ¯ 2 ç§’å‘é€ä¸€æ¡
      });
    }

    // é¡µé¢åŠ è½½æ—¶æ›´æ–°çŠ¶æ€
    window.addEventListener('load', () => {
      log('=== é€šçŸ¥æµ‹è¯•é¡µé¢å·²åŠ è½½ ===');
      updateStatus();
      
      // æ£€æŸ¥æ˜¯å¦åœ¨ PWA æ¨¡å¼
      const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                    window.navigator.standalone === true;
      if (!isPWA) {
        log('âš ï¸ è­¦å‘Š: å½“å‰ä¸åœ¨ PWA æ¨¡å¼ä¸‹', 'error');
        log('iOS ç”¨æˆ·éœ€è¦å°†åº”ç”¨æ·»åŠ åˆ°ä¸»å±å¹•æ‰èƒ½æ¥æ”¶é€šçŸ¥', 'info');
      }
    });
  </script>
</body>
</html>
